name: Daily Airtable -> timeline.json -> GitHub Pages

on:
  workflow_dispatch: {}
  schedule:
    - cron: "15 2 * * *"   # dagelijks 02:15 UTC

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - uses: actions/configure-pages@v5

      - name: Check Airtable secrets present
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
        run: |
          test -n "$AIRTABLE_TOKEN" && echo "AIRTABLE_TOKEN OK" || (echo "AIRTABLE_TOKEN MISSING" && exit 1)
          test -n "$AIRTABLE_BASE_ID" && echo "AIRTABLE_BASE_ID OK" || (echo "AIRTABLE_BASE_ID MISSING" && exit 1)

      - name: Build site + fetch Airtable -> site/data/timeline.json
        env:
          AIRTABLE_TOKEN: ${{ secrets.AIRTABLE_TOKEN }}
          AIRTABLE_BASE_ID: ${{ secrets.AIRTABLE_BASE_ID }}
          AIRTABLE_TABLE: ${{ secrets.AIRTABLE_TABLE }} # optioneel
          AIRTABLE_VIEW:  ${{ secrets.AIRTABLE_VIEW }}  # optioneel (liefst view-naam)
        run: |
          mkdir -p site
          rsync -av --exclude='.git' --exclude='.github' ./ site/

          node <<'NODE'
          const fs = require('fs');
          const path = require('path');

          const token = (process.env.AIRTABLE_TOKEN || "").trim();
          const baseId = (process.env.AIRTABLE_BASE_ID || "").trim();

          // default jouw table-id als secret leeg is:
          const table = (process.env.AIRTABLE_TABLE || "").trim() || "tblqTkV3DBJBx3t8V";
          // view liever als NAAM; laat leeg als je geen view wilt afdwingen
          const view = (process.env.AIRTABLE_VIEW || "").trim();

          if (!token || !baseId) process.exit(1);

          async function fetchAll() {
            let offset = null;
            const items = [];
            do {
              const url = new URL(`https://api.airtable.com/v0/${baseId}/${encodeURIComponent(table)}`);
              url.searchParams.set("pageSize", "100");
              url.searchParams.set("sort[0][field]", "Date");
              url.searchParams.set("sort[0][direction]", "asc");
              if (view) url.searchParams.set("view", view);
              if (offset) url.searchParams.set("offset", offset);

              const res = await fetch(url, { headers: { Authorization: `Bearer ${token}` }});
              if (!res.ok) throw new Error(`Airtable error ${res.status}: ${await res.text()}`);

              const json = await res.json();

              for (const r of (json.records || [])) {
                const f = r.fields || {};
                if (!f.Date) continue;

                const img = Array.isArray(f.Image) && f.Image[0]?.thumbnails?.large?.url
                  ? f.Image[0].thumbnails.large.url
                  : (Array.isArray(f.Image) && f.Image[0]?.url ? f.Image[0].url : null);

                items.push({
                  id: r.id,
                  title: f.Title || "",
                  date: f.Date || null,
                  endDate: f.EndDate || null,
                  description: f.Description || "",
                  category: f.Category || "Uncategorized",
                  link: f.Link || null,
                  image: img
                });
              }

              offset = json.offset || null;
            } while (offset);

            return items;
          }

          (async () => {
            const items = await fetchAll();
            const outDir = path.join(process.cwd(), "site", "data");
            fs.mkdirSync(outDir, { recursive: true });
            fs.writeFileSync(path.join(outDir, "timeline.json"), JSON.stringify({ items }, null, 2));
            console.log(`Wrote ${items.length} items to site/data/timeline.json`);
          })().catch(err => { console.error(err); process.exit(1); });
          NODE

          echo "---- verify ----"
          ls -la site/data || true
          test -f site/data/timeline.json || (echo "timeline.json NOT FOUND in site/data" && exit 1)

      - name: Upload Pages artifact (unique per attempt)
        uses: actions/upload-pages-artifact@v3
        with:
          name: pages-${{ github.run_id }}-${{ github.run_attempt }}
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    steps:
      - uses: actions/deploy-pages@v4
        with:
          artifact_name: pages-${{ github.run_id }}-${{ github.run_attempt }}
